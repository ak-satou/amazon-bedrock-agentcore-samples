# Amazon Bedrock AgentCore Gatewayを使用してAPIからMCPツールを実装

## 概要
Bedrock AgentCore Gatewayは、既存のAPI（OpenAPIとSmithy）をインフラストラクチャやホスティングの管理を必要とせずに、完全に管理されたMCPサーバーに変換する方法をお客様に提供します。お客様は既存のOpenAPIとSmithy仕様を持参して、それらのツールを変換できます。Gatewayはこれらすべてのツールにわたって統一されたModel Context Protocol（MCP）インターフェースを提供します。Gatewayは、受信リクエストとターゲットリソースへの発信接続の両方に対して安全なアクセス制御を確保するため、デュアル認証モデルを採用しています。フレームワークは2つの主要コンポーネントで構成されています：ゲートウェイターゲットへのアクセスを試みるユーザーを検証・認証するInbound Auth、およびAPIキー、OAuthトークン、AWS IAMロールを使用して認証されたユーザーに代わってゲートウェイがバックエンドAPIに安全に接続できるようにするOutbound Authです。

![動作の仕組み](images/apis-into-mcp-gateway.png)


## 概念の定義

開始する前に、Amazon Bedrock AgentCore Gatewayを使い始めるための重要な概念をいくつか定義しましょう：
OpenAPIまたはSmithy APIをグループ化して、Bedrock AgentCore Gateway Targetを作成できます。ターゲットは、APIを論理的にグループ化し、AmazonCore Gatewayにアタッチするために使用するリソースです。

## APIをGatewayターゲットにグループ化

以下は、APIをGatewayターゲットにグループ化するベストプラクティスです：
* マイクロサービスパラダイムに適用されるドメイン駆動設計の原則と同様に、エージェントアプリケーションのビジネスドメインに基づいてMCPツールをグループ化します。
* Gatewayターゲットの発信認証には、1つのリソースクレデンシャルプロバイダーのみをアタッチできます。発信認証器に基づいてツールをグループ化します。
* APIの種類、つまりOpenAPI、Smithy、または他のエンタープライズAPIへのブリッジとして機能するAWS Lambdaに基づいて、apiをグループ化します。

![APIツールをターゲットにグループ化](images/api-groups-targets.png)

## ベストプラクティス

1. ドキュメント品質ガイドライン
- 各APIエンドポイントとリソースについて明確で説明的な要約を記述
- 目的と機能を説明する自然言語の説明を使用
- 説明に実世界のユースケースを含める
- 必要でない限り技術用語を避ける
- ドキュメント全体で一貫した用語を確保

2. スキーマドキュメント
- すべてのフィールドに詳細な説明を提供
- フィールドの制約と検証ルールを含める
- データ型を正確に文書化
- 複雑なデータ構造の例を追加
- 異なるスキーマ間の関係を説明

3. OpenAPI仕様のベストプラクティス
- OpenAPIリンターを使用して仕様を検証
- 適切なセマンティックバージョニングを確保
- 完全なリクエスト/レスポンス例を含める
- エラーレスポンスとコードを文書化
- セキュリティスキーム定義を追加

4. ツール検索最適化
- 説明に関連キーワードを自然に含める
- 各APIをいつ使用するかについてのコンテキストを提供
- 代替アプローチや関連エンドポイントを文書化
- ビジネスドメインの用語を含める

5. API抽出ガイドライン
- エージェントタスクに必要なコア機能を特定
- ユースケースに基づいて焦点を絞ったAPIサブセットを作成
- 抽出されたAPI間のセマンティック関係を維持
- セキュリティ定義と共通スキーマを保持
- 抽出されたコンポーネント間の依存関係を文書化

6. モノリシックAPI抽出プロセス：
- 完全なOpenAPI仕様を確認
- エージェントのユースケースを特定のエンドポイントと認証要件にマップ
- 関連するパスとスキーマを抽出
- コンポーネントの依存関係を維持
- 抽出された仕様を検証
- セマンティック検索の効果をテスト

APIが進化するにつれて定期的にドキュメントを確認・更新し、エージェントの品質と正確性を維持することを忘れないでください。

## 受信と発信認証
Bedrock AgentCore Gatewayは、受信および発信認証を介して安全な接続を提供します。受信認証では、AgentCore Gatewayは呼び出し中に渡されるOAuthトークンを分析して、ゲートウェイ内のツールへのアクセスを許可または拒否することを決定します。ツールが外部リソースへのアクセスを必要とする場合、AgentCore GatewayはAPIキー、IAM、またはOAuthトークンを介して発信認証を使用して、外部リソースへのアクセスを許可または拒否できます。

受信認証フロー中、エージェントまたはMCPクライアントは、OAuthアクセストークン（ユーザーのIdPから生成）を追加してAgentCore Gateway内のMCPツールを呼び出します。AgentCore Gatewayは次にOAuthアクセストークンを検証し、受信認証を実行します。

AgentCore Gatewayで実行されているツールが外部リソースにアクセスする必要がある場合、OAuthはGatewayターゲットのリソースクレデンシャルプロバイダーを使用してダウンストリームリソースのクレデンシャルを取得します。AgentCore Gatewayは認証クレデンシャルを呼び出し元に渡して、ダウンストリームAPIへのアクセスを取得します。

![セキュアアクセス](../images/gateway_secure_access.png)

### チュートリアル詳細

| 項目                 | 詳細                                                   |
|:---------------------|:----------------------------------------------------------|
| チュートリアルタイプ        | インタラクティブ                                               |
| AgentCore構成要素 | AgentCore Gateway、AgentCore Identity                     |
| エージェント フレームワーク    | Strands Agents                                            |
| LLMモデル            | Anthropic Claude Sonnet 3.7、Amazon Nova Pro              |
| チュートリアル構成要素  | AgentCore Gatewayの作成とAgentCore Gatewayの呼び出し |
| チュートリアル分野    | 横断的                                            |
| 例の複雑さ   | 簡単                                                      |
| 使用SDK             | boto3                                                     |

## チュートリアル アーキテクチャ

### チュートリアル主要機能

* OpenAPI apiをMCPツールに変換
* SmithyモデルをMCPツールに変換

### チュートリアル概要

これらのチュートリアルでは、以下の機能について説明します：

- [OpenAPIをMCPツールに変換](01-transform-openapi-into-mcp-tools)
- [SmithyモデルをMCPツールに変換](02-transform-smithyapis-into-mcp-tools)