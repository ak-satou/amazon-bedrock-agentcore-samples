# Bedrock AgentCore Identityの仕組み

## はじめに

AgentCore Identityは、AIエージェントの展開における根本的な課題に対処します。それは、セキュリティやユーザーエクスペリエンスを損なうことなく、エージェントが複数のサービスにわたってユーザー固有のデータに安全にアクセスできるようにすることです。従来のアプローチでは、細かい制御なしに広範なアクセス認証情報を使用するか、各サービス統合に対して明示的なユーザー同意を必要とする（ユーザーエクスペリエンスが悪くなる）かのいずれかでした。AgentCore Identityは、ゼロトラストセキュリティ原則と委任ベースの認証を実装する包括的なワークフローを通じて、この問題を解決します。

このサービスは、偽装ではなく委任の原則で動作します。エージェントがユーザーの認証情報を直接使用する代わりに、エージェントは検証可能なユーザーコンテキストを持ちながら自分自身として認証します。このアプローチにより、細かいアクセス制御、包括的な監査証跡、ユーザーアクセスとは独立してエージェントアクセスを取り消す機能が実現されます。ワークフローは、開発者に簡潔なインターフェースを提示しながら、複数の信頼ドメインにわたって複雑な認証と認可を調整します。

本質的に、AgentCore Identityは、適切なセキュリティ境界を維持しながら、エージェントがリソースにアクセスするための安全な認証メカニズムを提供します。これにより、サービスが適切な認可決定を行うことができ、内部カレンダーシステムと単一のワークフロー内でGoogle Calendarなどの外部サービスにアクセスできるクロスサービスエージェントなどの高度なユースケースをサポートできます。

以下の図は、ユーザー、アプリケーション、エージェント、AWSリソース、サードパーティサービスが安全に相互作用する方法を示す、完全なAgentCore Identityワークフローを図解しています：

<div style="text-align:center">
    <img src="images/how_it_works.png" width="100%"/>
</div>

AgentCore Identityワークフローは、以下のステップで構成されます：

**ユーザーがOAuth/OIDCでサインインし、トークンをアプリケーションに渡す** — ユーザーは組織の既存のアイデンティティプロバイダー（Auth0、Cognito、その他のOIDC準拠システムなど）を通じて認証し、アクセストークンまたはアイデンティティトークンを受け取ります。このトークンには、ユーザーのアイデンティティ情報と認可されたスコープが含まれ、ワークフロー全体のユーザーのアイデンティティコンテキストを確立します。アプリケーションはこのトークンを受け取り、エージェントへのリクエストを認可するために使用します。

**ユーザー向けアプリケーションがユーザーサインインを処理する** — アプリケーションはユーザーの認証トークンを検証し、安全なセッションを確立します。このステップにより、ユーザーが適切に認証され、AIエージェントを呼び出す能力を含む、アプリケーションの機能にアクセスする権限があることが保証されます。アプリケーションは、個人化とアクセス制御の目的で、トークンからユーザーアイデンティティ情報を抽出することもあります。

**ユーザーがAIエージェントによるリソースアクセスを要求する** — ユーザーがエージェントとのインタラクションを開始すると、アプリケーションはユーザーに代わってAIエージェントを呼び出すリクエストを行います。このリクエストには、ユーザーの認証トークンと、エージェントが達成する必要があることについての必要なコンテキストが含まれます。アプリケーションは、ユーザーのアイデンティティコンテキストを維持しながら、ユーザーの認証されたリクエストをエージェントインフラストラクチャに転送するプロキシとして機能します。

**ユーザー向けアプリケーションがユーザートークンを使用してエージェントサービスにリクエストを行う** — Bedrock AgentCoreサービスはリクエストを受信し、設定された認可ポリシーに対してユーザーのトークンを検証します。この検証には、トークンの署名、有効期限、発行者、対象者、必要なスコープのチェックが含まれます。サービスは、ユーザーが特定のエージェントを呼び出すために必要な権限を持っていること、およびリクエストが処理を進める前にすべてのセキュリティ要件を満たしていることを確認します。

**Bedrock AgentCoreがAgent Credential Providerからワークロードアクセストークンをリクエストする** — エージェントサービスは、ワークロードアクセストークン（技術的にはワークロードアクセストークン）を取得するためのトークン交換プロセスを開始します。エージェントサービスは、ユーザーのトークンをAgentCore Identityのトークン交換APIに提出します。リクエストはIAM認証情報で認可されます。これにより、信頼の連鎖を維持し、認可決定をサポートしながら、ダウンストリームリソースへの安全で監査可能なアクセスが可能になります。

**AgentCore Identityがユーザートークンを検証し、ワークロードアクセストークンを発行する** — AgentCore Identityは、ユーザーのトークンの署名、有効期限、発行者、対象者、スコープを検証します。その後、ワークロードアクセストークンを返します。これにより、信頼の連鎖を維持しながら、ダウンストリームリソースへの安全で監査可能なアクセスが可能になります。AgentCore Identityは、エージェントのアイデンティティの検証、ユーザーの元のOAuth/OIDCトークンの署名とクレームの検証、エージェントがユーザーに代わって要求されたリソースにアクセスする権限があることの確認を含む、包括的なゼロトラスト検証を実行します。この検証は、ソースや以前の信頼関係に関係なく行われ、すべてのリクエストが独立して認証・認可されることを保証します。

**AIエージェントアプリケーションがエージェントを呼び出す** — エージェントアプリケーションは、ワークロードアクセストークンを受け取り、要求されたタスクの実行を開始します。エージェントは、自身のアイデンティティと代理で動作しているユーザーの両方の検証可能な証明を持って動作できるようになります。これにより、エージェントは、元のユーザーへのアクションの完全な追跡可能性を維持しながら、さまざまなツールやリソースに認証されたリクエストを行うことができます。

**エージェントがリソースアクセストークンをリクエストする** — エージェントがAWSリソースやサードパーティサービス（Google Calendar、Slack、内部APIなど）にアクセスする必要がある場合、AgentCore Credential Providerから適切な認証情報をリクエストします。エージェントは、自身のアイデンティティと認可の証明として、ワークロードアクセストークンを提示します。システムはこのトークンを検証し、設定されたポリシーとユーザー同意に基づいて、エージェントがアクセスすることを許可されているリソースを決定します。AgentCore Identityが要求されたユーザーアイデンティティとリソースに対する既存のトークンを持っている場合、リソースアクセストークンを返します。

**Amazon Bedrock AgentCore Identityがリソースでのユーザー認証をリクエストする** — AgentCore Identityがトークンボルトに要求されたリソースの既存のアクセストークンを持っていない場合、提供されたURLでユーザー同意が必要であることを示すレスポンスを返します。明示的なユーザー同意を必要とするリソース（Google Calendarなどのサードパーティサービス）の場合、システムはユーザー認証フローを開始する必要があります。これは通常、ユーザーをリソースプロバイダーの認可サーバー（GoogleのOAuth 2.0エンドポイントやMicrosoftのAzure ADなど）にリダイレクトして、エージェントが自分のデータにアクセスする権限を付与することを含みます。このステップにより、ユーザーは、エージェントが自分に代わってアクセスできるリソースを制御し続けることができ、OAuth 2.0クライアント認証情報付与（マシン間）とOAuth 2.0認証コード付与（ユーザー委任アクセス）フローの両方をサポートします。

**Bedrock AgentCoreがユーザー認証をリクエストする** — エージェントサービスは、要求された認可URLを渡して、ユーザー向けアプリケーションにレスポンスを返します。

**ユーザー向けアプリケーションが認証と同意プロンプトを表示する** — ユーザーは、認証情報を入力し、エージェントとデータを共有するよう促されます。

**ユーザーがデータ共有に同意する** — ユーザーは、サードパーティプロバイダーからの同意プロンプトを受け入れます。

**サードパーティリソースがユーザー認証情報を検証し、リソースアクセストークンを発行する** — サードパーティサービスプロバイダー（Google、Microsoft、Salesforceなど）は、ユーザーの認証情報と同意を検証し、エージェントが使用するためのアクセストークンを発行します。このトークンは通常、ユーザーがエージェントに明示的に付与した権限のみにスコープされ、最小権限アクセスの原則に従います。この認可リクエストからのコールバックURLは、プロバイダーレスポンスを処理し、要求されたリソースのアクセストークンを収集するAgentCore Identityサービスエンドポイントです。

**AgentCore Identityがリソースアクセストークンを保存して返す** — AgentCore Identityは、エージェントからのリクエストに対してリソースアクセストークンを返します。また、サービスは将来の使用のためにトークンボルトにリソースアクセストークンを安全に保存し、特定のエージェントアイデンティティとユーザーアイデンティティの組み合わせに関連付けます。これにより、後続のリクエストが繰り返しユーザー認証を必要とすることなくトークンを再利用でき、セキュリティを維持しながらユーザーエクスペリエンスを向上させます。トークンは暗号化され、不正な取得を防ぐためにアクセス制御されます。トークンボルトはゼロトラスト原則の下で動作し、認証情報は元々それらを取得した正確なエージェントとユーザーの組み合わせのみがアクセスできることを保証します。これにより、異なるエージェントやユーザー間での不正なクロスアクセスを防ぎます。

**エージェントがリソースからデータをリクエストする。** — リソース固有のアクセストークンを使用して、エージェントはサードパーティリソースからデータを読み書きするためのAPIコールを行います。エージェントは、ユーザーが付与した権限とリソースプロバイダーAPIによって定義された機能の範囲内で動作します。すべてのアクションは、監査とセキュリティの目的で、エージェントのアイデンティティが明確に確立された状態で実行されます。

**サードパーティリソースがリソースアクセストークンを検証し、データを返す** — サードパーティサービスは、エージェントによって提供されたアクセストークンを検証し、それが有効で期限切れでなく、要求された操作に必要なスコープを持っていることを確認します。検証が成功すると、リソースは要求されたデータを返すか、要求されたアクションの完了を確認します。この検証により、適切なユーザー同意を持つ認可されたエージェントのみが保護されたリソースにアクセスできることが保証されます。

**AIエージェントアプリケーションがレスポンスを組み立てる** — エージェントは、AWSリソースとサードパーティサービスから受信したデータを処理し、追加のロジックとコンテキストと組み合わせて包括的なレスポンスを作成します。エージェントは、ユーザーの元のリクエストについてのコンテキストを維持し、アクセスしたリソースからのデータを取り込みながら、レスポンスがユーザーのニーズに対応することを保証します。

**AgentCoreがアプリケーションにレスポンスを返す** — エージェントは、完了したレスポンスをユーザー向けアプリケーションに送り返します。このレスポンスには、エージェントのアクションの結果、AWSリソースとサードパーティサービスから取得したデータ、完了したタスクの確認が含まれます。レスポンスは、セキュリティコンテキストを維持し、ユーザーに代わって実行されたアクションについての監査情報を提供します。

**ユーザー向けアプリケーションがレスポンスを表示する** — アプリケーションは、エージェントのレスポンスを適切な形式でユーザーに提示します。それがテキスト、構造化データ、または完了したアクションの確認であっても。ユーザーは、自分のリクエストの結果を確認し、エージェントがさまざまなリソースへの認可されたアクセスを使用して何を達成したかを理解できます。

**プロセス完了（終了）** — ワークフローは、すべてのトークンが適切に管理され、監査ログが記録され、ユーザーのリクエストが満たされた状態で完了します。システムは、複数のサービスとプラットフォームにわたって自分のデータにアクセスし操作するためにAIエージェントを活用したいユーザーに対して、プロセス全体を通してセキュリティを維持しながらシームレスなエクスペリエンスを提供します。

このワークフローは、AgentCore Credential Providerを従来の認証アプローチと区別するいくつかの主要な技術原則に基づいて構築されています。サービスは、ソースや以前の信頼関係に関係なく、すべてのリクエストが検証されるゼロトラストセキュリティを実装しています。偽装ではなく委任ベースの認証を使用し、エージェントがユーザーコンテキストを運びながら常に自分自身として認証することを保証します。サービスは、エージェントからツールへの通信のための標準プロトコルをサポートするMCP（Model Context Protocol）準拠です。最後に、クロスプラットフォームサポートを提供し、エージェントが一貫したセキュリティ標準を維持しながら、AWS、他のクラウドプロバイダー、オンプレミス環境にわたって動作できるようにします。