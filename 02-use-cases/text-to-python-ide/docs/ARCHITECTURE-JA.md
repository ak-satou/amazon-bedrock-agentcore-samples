# アーキテクチャ概要

## システムアーキテクチャ

AgentCore Code Interpreterは、現代的な3層アーキテクチャに従います：

```
┌─────────────────────────────────────────────────────────────────┐
│                     プレゼンテーション層                         │
│                  フロントエンド（React + AWS Cloudscape）        │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐   │
│  │  コード生成     │ │   コードエディター │ │ 実行結果        │   │
│  │      タブ        │ │      タブ        │ │      タブ        │   │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘   │
└─────────────────────────┬───────────────────────────────────┘
                              │ HTTP/WebSocket
┌─────────────────────────────┴───────────────────────────────────┐
│                     アプリケーション層                            │
│                バックエンド（FastAPI + Strands-Agents）          │
│  ┌─────────────────┐                    ┌─────────────────┐     │
│  │ コード生成      │                    │ コード実行      │     │
│  │     エージェント │                    │     エージェント │     │
│  │ (Strands-Agents)│                    │ (Strands-Agents)│     │
│  └─────────┬───────┘                    └─────────┬───────┘     │
└────────────┼────────────────────────────────────────┼───────────┘
             │                                        │
┌────────────┴────────────────────────────────────────┴───────────┐
│                      サービス層                                 │
│                     AWS Bedrockサービス                        │
│  ┌─────────────────┐                    ┌─────────────────┐     │
│  │ Claude Sonnet3.7│                    │   AgentCore     │     │
│  │ （推論         │                    │ CodeInterpreter │     │
│  │  プロファイル）  │                    │   （サンドボックス）│     │
│  └─────────────────┘                    └─────────────────┘     │
│  ┌─────────────────┐                                            │
│  │  Nova Premier   │                                            │
│  │ （推論         │                                            │
│  │  プロファイル）  │                                            │
│  └─────────────────┘                                            │
└─────────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

### フロントエンド層（React）
- **技術**: React 18 + AWS Cloudscape Design System
- **目的**: コード生成と実行のユーザーインターフェース
- **コンポーネント**:
  - コード生成器: 自然言語入力とAIコード生成
  - コードエディター: MonacoベースのPythonコードエディター
  - 実行結果: エラーハンドリング付きフォーマット済み出力表示
- **通信**: HTTP REST APIとリアルタイム更新用WebSocket

### バックエンド層（FastAPI）
- **技術**: FastAPI + Strands-Agentsフレームワーク
- **目的**: ビジネスロジックとAIエージェントオーケストレーション
- **コンポーネント**:
  - **コード生成エージェント**: 自然言語をPythonコードに変換
  - **コード実行エージェント**: Pythonコードを安全に実行
  - **セッションマネージャー**: ユーザーセッションと会話履歴を処理
  - **APIゲートウェイ**: RESTfulエンドポイントとWebSocketハンドラー
- **機能**:
  - インテリジェントモデルフォールバック
  - セッション永続化
  - エラーハンドリングとログ

### サービス層（AWS Bedrock）
- **技術**: AWS Bedrock + AgentCore
- **目的**: AIモデル推論とコード実行
- **コンポーネント**:
  - **Claude Sonnet 3.7**: 主要AIモデル（推論プロファイル）
  - **Nova Premier**: フォールバックAIモデル（推論プロファイル）
  - **Claude 3.5 Sonnet**: セーフティネットモデル
  - **AgentCore**: サンドボックス化されたPython実行環境

## データフロー

### コード生成フロー
```
ユーザー入力 → フロントエンド → バックエンドAPI → Strandsエージェント → Bedrockモデル → レスポンス
    ↓
生成コード → コードエディター → 実行準備完了
```

### コード実行フロー
```
Pythonコード → バックエンドAPI → Strandsエージェント → AgentCoreサンドボックス → 実行結果
    ↓
結果 → フロントエンド → フォーマット済み表示
```

## 主要設計原則

### 1. **関心の分離**
- フロントエンドはUI/UXのみを処理
- バックエンドはビジネスロジックを管理
- AWSサービスがAIと実行機能を提供

### 2. **フォルトトレランス**
- 複数のAIモデルフォールバック
- 適切なエラーハンドリング
- セッション回復メカニズム

### 3. **セキュリティ**
- サンドボックス化されたコード実行
- AWS IAMベースのアクセス制御
- 入力検証とサニタイゼーション

### 4. **スケーラビリティ**
- ステートレスなバックエンド設計
- クラウドネイティブサービス
- 水平スケーリング機能

### 5. **拡張性**
- プラグインベースのエージェントアーキテクチャ
- 設定可能なモデル選択
- モジュラーコンポーネント設計

## 技術スタック

| 層 | 技術 | 目的 |
|-------|------------|---------|
| **フロントエンド** | React 18 | ユーザーインターフェースフレームワーク |
| | AWS Cloudscape | デザインシステムとコンポーネント |
| | Monaco Editor | コード編集機能 |
| **バックエンド** | FastAPI | 高性能APIフレームワーク |
| | Strands-Agents | AIエージェントオーケストレーション |
| | Python 3.8+ | ランタイム環境 |
| **AIサービス** | AWS Bedrock | AIモデルホスティング |
| | Claude Sonnet 3.7 | 主要言語モデル |
| | Nova Premier | フォールバック言語モデル |
| **実行** | AgentCore | サンドボックス化されたコード実行 |
| **インフラ** | AWS | クラウドプラットフォーム |

## セキュリティアーキテクチャ

### 認証と認可
- AWS IAMロールとポリシー
- プロファイルベースまたはアクセスキー認証
- 最小権限アクセス原則

### コード実行セキュリティ
- 分離されたサンドボックス環境
- リソース制限とタイムアウト
- ネットワーク分離
- 永続ストレージアクセスなし

### データ保護
- 暗号化通信（HTTPS/WSS）
- 機密データログなし
- セッションベースのデータ分離

## デプロイアーキテクチャ

### 開発環境
```
ローカルマシン
├── フロントエンド（localhost:3000）
├── バックエンド（localhost:8000）
└── AWSサービス（リモート）
```

### 本番環境
```
AWSクラウド
├── フロントエンド（S3 + CloudFront）
├── バックエンド（ECS/Lambda）
├── ロードバランサー（ALB）
└── Bedrockサービス
```

## パフォーマンス考慮事項

### 最適化戦略
- **モデルキャッシング**: 初期化されたモデルの再利用
- **接続プーリング**: 効率的なAWSサービス接続
- **非同期処理**: ノンブロッキングI/O操作
- **レスポンスストリーミング**: リアルタイム結果配信

### モニタリングと可観測性
- ヘルスチェックエンドポイント
- 包括的なログ
- エラー追跡とアラート
- パフォーマンスメトリクス収集

このアーキテクチャは、AI駆動のコード生成と実行のための堅牢でスケーラブルかつセキュアなプラットフォームを提供します。