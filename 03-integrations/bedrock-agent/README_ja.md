# Amazon Bedrock Agent と Bedrock AgentCore Gateway の統合

## 概要

このユースケースでは、**Amazon Bedrock Agents** と **Amazon Bedrock AgentCore Gateway** の完全なエンドツーエンド統合を、**Model Context Protocol (MCP)** を使用してAWS LambdaとDynamoDBで構築された実用的なフルーツスタンドバックエンドAPIと接続する方法を示します。このデモンストレーションでは、MCPがAIエージェントと既存のバックエンドシステム間のシームレスな通信を可能にし、エージェントが複雑な統合作業を必要とせずに現実世界のツールやデータにアクセスできることを説明します。

**主要な統合フォーカス: Model Context Protocol (MCP)**
MCPは、AIエージェントが外部データソースやツールに安全に接続できるオープンスタンダードです。このユースケースでは：
- **Bedrock Agent** は標準的なアクショングループ呼び出しを使用してGatewayと通信します
- **AgentCore Gateway** はこれらの呼び出しをMCP互換形式に変換します
- **バックエンドLambda関数** は自動的にMCPツールとして公開されます
- **リアルタイムデータアクセス** はMCPの標準化されたプロトコルを通じて実現されます

### ユースケースの詳細
| 項目                 | 詳細                                                                                                                             |
|---------------------|-----------------------------------------------------------------------------------------------------------------------------------|
| ユースケースタイプ      | 対話型                                                                                                                          |
| エージェントタイプ      | シングルエージェント                                                                                                              |
| ユースケースコンポーネント | ツール統合、MCPプロトコル、認証、リアルタイムデータアクセス、自然言語処理                                                           |
| ユースケース業界        | Eコマース / 小売                                                                                                               |
| サンプルの複雑さ       | 中級                                                                                                                           |
| 使用SDK             | Amazon Bedrock AgentCore SDK、boto3                                                                                            |

### ユースケースアーキテクチャ

![アーキテクチャ図](architecture.png)

```
ユーザークエリ → Bedrock Agent → Bridge Lambda → AgentCore Gateway → Backend Lambda → DynamoDB
```

### ユースケースの主要機能

- **バックエンドの変更不要**: 既存のLambda関数はGateway統合によりそのまま動作します
- **自動ツール検出**: GatewayはLambda関数を自動的にエージェントツールとして公開します
- **MCPプロトコル処理**: GatewayはModel Context Protocolの通信を透過的に管理します
- **自然言語処理**: Bedrock Agentはユーザーリクエストを解釈し、適切なツールを選択します
- **リアルタイムデータ統合**: エージェントの応答はDynamoDBからのライブデータを反映します
- **シームレス認証**: すべてのコンポーネント間で安全な通信を実現します

#### 主要コンポーネント:

1. **Amazon Bedrock Agent**: 基盤モデルの推論を使用してユーザーリクエストを理解し、ツール使用を調整します
2. **Bridge Lambda**: Bedrock Agentのアクショングループ呼び出しをMCP形式に変換します
3. **Amazon Bedrock AgentCore Gateway**: バックエンドAPIを自動的にMCP互換ツールに変換します
4. **Backend Lambda (Fruit Stand API)**: 在庫と注文管理のための既存のビジネスロジックです
5. **DynamoDBテーブル**: フルーツスタンドビジネスのデータ永続化レイヤーです
6. **Amazon Cognito**: 安全なGatewayアクセスのためのOAuth2認証を提供します

#### Amazon Cognito による認証

**Cognitoが必要な理由:**
Bedrock AgentCore Gatewayは、バックエンドAPIを保護するために安全な認証を必要とします。Amazon Cognitoは以下を提供します：

- **OAuth2 Client Credentials Flow**: 安全なマシン間認証
- **JWTトークン管理**: 自動的なトークン生成と検証
- **アクセス制御**: 認可されたエージェントのみがツールにアクセスできることを保証
- **スケーラブルなアイデンティティ管理**: カスタムコードなしで認証を処理

**動作方法:**
1. Cognito User Poolがアイデンティティプロバイダーとして機能
2. Gateway用にクライアント認証情報（ID/Secret）が設定される
3. Bridge LambdaがCognitoを使用して自動的にJWTトークンを生成
4. Gatewayはツールアクセス許可前にトークンを検証
5. バックエンドAPIは認証されたGatewayの背後で安全に保たれる

#### このデモンストレーションの内容

**Amazon Bedrock Agents** は基盤モデル（FM）、API、データの推論機能を使用してユーザーリクエストを分解し、関連情報を収集し、効率的にタスクを完了します—チームが高価値の作業に集中できるようにします。

**Amazon Bedrock AgentCore Gateway** は、API、Lambda関数、既存のサービスを自動的にMCP互換ツールに変換するため、開発者は複雑な統合を管理することなく、これらの必須機能をエージェントで迅速に利用できます。

#### 解決された統合の課題

従来、AIエージェントを既存のバックエンドシステムに接続するには、複雑なAPI統合、プロトコル変換、ツール管理、認証処理が必要でした。このユースケースでは、Gatewayが以下のようにこれらの課題を解決する方法を示します：

- **「どんなフルーツがありますか？」** → エージェントがGateway経由で在庫ツールを呼び出し
- **「ボブ用にリンゴ2個の注文を作成して」** → エージェントが注文作成ツールを呼び出し
- **「注文ABC123の詳細を取得して」** → エージェントが注文情報を取得

## 前提条件

* Python 3.9以上
* 適切な権限を持つAWSアカウント
* 認証情報で設定されたAWS CLI 2.x
* Jupyter NotebookまたはJupyterLab
* AWS API呼び出し用のインターネット接続
* 以下のAWSサービスへのアクセス:
  * Amazon Bedrock
  * AWS Lambda
  * Amazon DynamoDB
  * Amazon Cognito（Gateway認証用）
  * AWS IAM
* 必要なAWS権限: 管理者ロールからこのサンプルを実行する場合は無視
  * `bedrock:*` - Bedrock Agent操作用
  * `lambda:*` - Lambda関数管理用
  * `dynamodb:*` - DynamoDBテーブル操作用
  * `iam:*` - ロールとポリシー管理用
  * `cognito-idp:*` - OAuth2認証設定用

## ユースケースのセットアップ

前提条件パッケージをインストールし、環境を設定します：

```bash
# プロジェクトディレクトリに移動
cd 06-BedrockAgent-Integration

# 仮想環境を作成
python -m venv .venv
.venv/bin/activate

# Bedrock AgentCore Gateway用に必要なパッケージをインストール
pip install -r requirements.txt

# 残りのパッケージをインストール
pip install jupyter notebook requests urllib3

# AWS認証情報を設定
aws configure
```

## 実行手順

Jupyter notebookを実行してユースケースを実行します：

```bash
# Jupyter Notebookを開始
jupyter notebook

# notebookファイルを開く
# Bedrock_Agent_Integration_with_Bedrock_AgentCore_Gateway.ipynb
```

notebookのセルを順番に実行します：

1. **ステップ1-2**: 依存関係のインストールとIAMロールの作成
2. **ステップ3**: 注文と在庫用のDynamoDBテーブルの作成
3. **ステップ4**: Cognito認証のセットアップ
4. **ステップ5**: ターゲットLambda関数のデプロイ
5. **ステップ6-7**: Bedrock AgentCore Gatewayの作成と設定
6. **ステップ8**: Gateway統合のテスト
7. **ステップ9-12**: Bedrock Agentの作成と設定
8. **ステップ13**: エンドツーエンドテスト

デプロイ後、自然言語クエリを使用してインテリジェントエージェントと対話できます：

## 対話例

### クエリ1: 利用可能な在庫を確認
**ユーザー入力:**
```
🤔 ユーザー: どんなフルーツがありますか？
```

**エージェントの応答:**
```
🤖 拡張エージェント: 利用可能なフルーツと現在の価格・在庫レベルは以下の通りです：

- イチゴ: $3.99/ポンド、25ポンド在庫
- オレンジ: $0.75/個、80個在庫  
- バナナ: $0.50/個、148個在庫
- リンゴ: $1.20/個、97個在庫
- ブルーベリー: $4.50/パイント、30パイント在庫
```

### クエリ2: 注文を作成
**ユーザー入力:**
```
🤔 ユーザー: ボブ用にリンゴ2個の注文を作成して
```

**エージェントの応答:**
```
🤖 拡張エージェント: ボブ用のリンゴ2個の注文が正常に作成されました。注文詳細は以下の通りです：

注文ID: e2c57daf
顧客名: ボブ
商品:
- リンゴ2個 @$1.2各、合計$2.4
合計金額: $2.4
ステータス: 保留中
作成日時: 2025-07-14T01:39:58.042975
```

### クエリ3: 複数アイテムの複雑な注文
**ユーザー入力:**
```
🤔 ユーザー: アリス用にリンゴ3個とバナナ2個の注文をお願いします
```

**エージェントの応答:**
```
🤖 拡張エージェント: 完璧です！アリス用の注文を作成しました。詳細は以下の通りです：

注文ID: f8a9b2c1
顧客名: アリス
商品:
- リンゴ3個 @$1.20各、合計$3.60
- バナナ2個 @$0.50各、合計$1.00
合計金額: $4.60
ステータス: 保留中
作成日時: 2025-07-14T02:15:33.891234

在庫は新しい在庫レベルを反映するように自動的に更新されました。
```

### クエリ4: 注文ステータスを確認
**ユーザー入力:**
```
🤔 ユーザー: 注文e2c57dafの詳細を取得してもらえますか？
```

**エージェントの応答:**
```
🤖 拡張エージェント: 注文e2c57dafの詳細は以下の通りです：

注文ID: e2c57daf
顧客名: ボブ
商品:
- リンゴ2個 @$1.20各、合計$2.40
合計金額: $2.40
ステータス: 保留中
作成日時: 2025-07-14T01:39:58.042975
```

### これらの例が示すもの

1. **自然言語理解**: エージェントは同じ情報を求める様々な質問の仕方を解釈します
2. **自動ツール選択**: エージェントは適切なバックエンド関数（在庫リスト、注文作成、注文取得）を選択します
3. **リアルタイムデータ**: すべての応答は現在のデータベース状態を反映します
4. **ビジネスロジック統合**: 注文が作成されると在庫が自動的に更新されます
5. **構造化された応答**: エージェントはユーザーフレンドリーな方法でデータをフォーマットします
6. **エラーハンドリング**: システムは無効なリクエストや在庫不足を適切に処理します

## クリーンアップ手順

作成されたすべてのインフラストラクチャを削除し、継続的な料金を回避するには、notebookの最後にあるクリーンアップセクションを実行します：

```bash
# notebookのクリーンアップセルを実行して以下を削除:
# - Bedrock AgentとAction Groups
# - Lambda関数（BridgeとTarget）
# - GatewayとGateway Targets
# - DynamoDBテーブル
# - Cognitoリソース
# - IAMロールとポリシー
```

## トラブルシューティング

**よくある問題:**

1. **IAM権限エラー**: AWS認証情報に十分な権限があることを確認してください
2. **DynamoDB Decimalエラー**: notebookはDecimal型変換を自動的に処理します
3. **Gatewayタイムアウト**: 操作に時間がかかる場合はLambdaタイムアウト設定を増加させてください
4. **認証失敗**: Cognito設定と認証情報を確認してください

## データベーススキーマ参照

**FruitInventoryテーブル:**
- `fruit_name` (String, Primary Key): フルーツの名前
- `price` (Number): 単位あたりの価格
- `unit` (String): 測定単位（個、ポンド、パイント）
- `stock` (Number): 利用可能数量

**FruitOrdersテーブル:**
- `order_id` (String, Primary Key): 一意の注文識別子
- `customer_name` (String): 顧客名
- `items` (List): 数量と価格付きの注文アイテム
- `total_cost` (Number): 注文の合計金額
- `status` (String): 注文ステータス（保留中、完了など）
- `created_at` (String): 注文作成のISOタイムスタンプ

## 免責事項
このリポジトリで提供される例は実験的および教育的目的のみです。概念や技術を示していますが、本番環境での直接使用は意図されていません。[プロンプトインジェクション](https://docs.aws.amazon.com/bedrock/latest/userguide/prompt-injection.html)から保護するためにAmazon Bedrock Guardrailsを適切に配置してください。